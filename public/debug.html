<!DOCTYPE html>
<html>
<head>
    <title>CoHunt Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 15px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>CoHunt Debug Test</h1>
    
    <div class="step">
        <h3>Step 1: Upload Resume</h3>
        <input type="file" id="resumeFile" accept=".txt,.pdf">
        <button onclick="uploadResume()">Upload Resume</button>
        <div id="uploadResult"></div>
    </div>
    
    <div class="step">
        <h3>Step 2: Search Jobs</h3>
        <input type="text" id="jobQuery" placeholder="Job title" value="Software Tester">
        <input type="text" id="location" placeholder="Location" value="Iceland">
        <button onclick="searchJobs()">Search Jobs</button>
        <div id="searchResult"></div>
    </div>
    
    <div class="step">
        <h3>Raw API Responses</h3>
        <div id="rawData"></div>
    </div>

    <script>
        let sessionId = null;
        
        async function uploadResume() {
            const fileInput = document.getElementById('resumeFile');
            const resultDiv = document.getElementById('uploadResult');
            
            if (!fileInput.files[0]) {
                // Create a test file
                const testContent = 'Test resume: Software Tester with 5 years experience in Iceland. Skills: Selenium, JIRA, TestNG.';
                const testFile = new File([testContent], 'test-resume.txt', { type: 'text/plain' });
                
                const formData = new FormData();
                formData.append('resume', testFile);
                
                try {
                    const response = await fetch('/api/upload-resume', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        sessionId = data.sessionId;
                        resultDiv.innerHTML = `<div class="success">‚úÖ Resume uploaded! Session ID: ${sessionId}</div>`;
                        
                        // Store in localStorage like the main app
                        localStorage.setItem('cohunt-session-id', sessionId);
                        localStorage.setItem('cohunt-resume-uploaded', 'true');
                    } else {
                        resultDiv.innerHTML = `<div class="error">‚ùå Upload failed: ${data.error}</div>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Upload error: ${error.message}</div>`;
                }
            }
        }
        
        async function searchJobs() {
            const query = document.getElementById('jobQuery').value;
            const location = document.getElementById('location').value;
            const resultDiv = document.getElementById('searchResult');
            const rawDiv = document.getElementById('rawData');
            
            // Use session ID from upload or localStorage
            const currentSessionId = sessionId || localStorage.getItem('cohunt-session-id');
            
            try {
                const response = await fetch('/api/search-jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        location: location,
                        sessionId: currentSessionId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const firstJob = data.jobs[0];
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Search successful! Found ${data.jobs.length} jobs</h4>
                            <h5>First Job:</h5>
                            <p><strong>Title:</strong> ${firstJob.title}</p>
                            <p><strong>Company:</strong> ${firstJob.company}</p>
                            <p><strong>Location:</strong> ${firstJob.location}</p>
                            <p><strong>Match Score:</strong> ${firstJob.matchScore || 'None'}</p>
                            <p><strong>Salary:</strong> ${firstJob.salary}</p>
                            <p><strong>URL:</strong> <a href="${firstJob.url}" target="_blank">View Job</a></p>
                        </div>
                    `;
                    
                    rawDiv.innerHTML = '<h4>Raw Response:</h4><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Search failed: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Search error: ${error.message}</div>`;
            }
        }
        
        // Load existing session on page load
        window.onload = function() {
            const savedSessionId = localStorage.getItem('cohunt-session-id');
            if (savedSessionId) {
                sessionId = savedSessionId;
                document.getElementById('uploadResult').innerHTML = 
                    `<div class="success">üì± Using saved session: ${sessionId}</div>`;
            }
        };
    </script>
</body>
</html>